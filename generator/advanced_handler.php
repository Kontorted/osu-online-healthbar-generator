<?php

    include "etc/utilities.php";
    
    session_start();

    if($_SERVER['REQUEST_METHOD'] != "POST") {
        header("Location: /generator/advanced");
        die();
    }

    extract($_POST);
    
    $proportions = isset($proportions);
    $flagOverride = isset($flagOverride);
    $imageOverride = isset($imageOverride);
    $noAvatar = isset($noAvatar);
    
    if(!isset($submittedImage)) {
        $submittedImage = "";
    }
    
    if($flagOverride) {
        if(isset($flagOverrideData)) {
            $flagOverrideData == substr($flagOverrideData, 0, 2);
        } else {
            returnWithError("Please select a flag", "/generator/advanced");
        }
    } else {
        $flagOverrideData = "";
    }
    
    if($imageOverride) {
        if(isset($_FILES['customImage']['error'])) {
            if(!isset($_SESSION["advanced"]["imageOverrideFileName"]) || $_SESSION["advanced"]["imageOverrideFileName"] !== $submittedImage) {
                handleFile();
            }
        } else {
            returnWithError("Please select an image", "/generator/advanced");
        }
    }
    
    $_SESSION['advanced'] = array (
        "proportions" => $proportions,
        "flagOverride" => $flagOverride,
        "flagOverrideData" => $flagOverrideData,
        "imageOverride" => $imageOverride,
        "noAvatar" => $noAvatar,
        "imageOverrideFileName" => $submittedImage
    );
    
    header("Location: /generator");
    
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    
    function handleFile() {
        
        //Check that the upload folder is not bigger than 500MB
        if(folderSize(CUSTOM_IMAGES_UPLOAD_DIR) >= 524288000) {
            returnWithError("Sorry, but there are already too many uploaded images at this moment. Please, try again later.", "/generator/advanced");
        }
        
        //Check that there is only 1 file
        if(is_array($_FILES['customImage']['error'])) {
            throw new RuntimeException("Trying to upload multiple files!");
        }
        
        //Check that the upload is ok
        switch($_FILES['customImage']['error']) {
            case UPLOAD_ERR_OK:
                break;
            case UPLOAD_ERR_NO_FILE:
                throw new RuntimeException('No file sent.');
            case UPLOAD_ERR_INI_SIZE:
            case UPLOAD_ERR_FORM_SIZE:
                throw new RuntimeException('Exceeded filesize limit: ' . $_FILES['customImage']['size']);
            default:
                throw new RuntimeException('Unknown errors.');
        }
        
        //Check the size
        $size = $_FILES['customImage']['size'];
        if($size > 1048576) {
            throw new RuntimeException('Exceeded filesize limit: ' . $size);
        }
        
        //Check file type
        $finfo = finfo_open(FILEINFO_MIME_TYPE);
        $mimetype = finfo_file($finfo, $_FILES['customImage']['tmp_name']);
        finfo_close($finfo);
        
        if(array_search($mimetype, ["image/jpg", "image/jpeg", "image/png", "image/gif"], true) === false) {
            throw new RuntimeException('Invalid file format: ' . $mimetype);
        }
        
        //Try to move it to the folder
        if(!move_uploaded_file($_FILES['customImage']['tmp_name'], CUSTOM_IMAGES_UPLOAD_DIR."/".session_id()."_custom")) {
            throw new RuntimeException("Failed at moving file");
        }
    }

?>